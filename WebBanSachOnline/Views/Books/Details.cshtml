@model WebBanSachOnline.Models.Book

@{
    ViewBag.Title = "Details";
}


<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nhà Sách Online</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css"
          rel="stylesheet" />
    <!-- Font Awesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
          rel="stylesheet" />
    <!-- Custom CSS -->
    <link href="~/Content/style.css" rel="stylesheet" />
    <style>
        .book-image {
            width: 100%;
            max-height: 400px;
            object-fit: contain;
        }

        .detail-section {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            background-color: #fff;
        }

        .rating-stars .fa-star {
            color: #ffd700;
            cursor: pointer;
        }

            .rating-stars .fa-star.empty {
                color: #e4e5e9;
            }

        .book-price {
            font-weight: bold;
            color: #dc3545;
        }

        .original-price {
            text-decoration: line-through;
            color: #6c757d;
            margin-right: 10px;
        }

        .review-box {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .review-date {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .modal-notification {
            max-width: 400px;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
        }

        .quantity-controls button {
            width: 30px;
            height: 30px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .quantity-controls input {
            width: 50px;
            text-align: center;
        }
    </style>
</head>
<body>



    <!-- Main Content -->
    <div class="container mt-4">
        <nav aria-label="breadcrumb" class="bg-light p-2 rounded mb-4 shadow-sm">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a href="/">Trang chủ</a>
                </li>
                <li class="breadcrumb-item">
                    <a href="/Categories">Danh mục sách</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    Xem chi tiết sách
                </li>
            </ol>
        </nav>

        <!-- Book Details -->
        @{
            string imagePath = "~/BookImages/" + Model.image;
        }
        <div class="row mb-4">
            <!-- Book Image Column -->
            <div class="col-md-4 mb-4">
                <div class="detail-section mb-3 text-center">
                    <img id="book-image"
                         src="@Url.Content(imagePath)"
                         class="book-image mb-3"
                         alt="@Model.title" />
                </div>
            </div>

            <!-- Book Info Column -->
            <div class="col-md-8">
                <div class="detail-section">
                    <h3 id="book-title" class="mb-2">@Model.title</h3>
                    <br />
                    <div class="mb-2">
                        <span>Tác giả: </span>
                        <span id="book-author" class="fw-semibold">Paulo Coelho</span>
                    </div>
                    <div class="mb-2">
                        <span>Danh mục: </span>
                        <span id="book-category" class="fw-semibold">Văn học</span>
                    </div>
                    <div class="mb-2">
                        <span>Còn: </span>
                        <span id="book-stock" class="fw-semibold">@(Model.quantity - Model.soldQuantity)</span>
                    </div>
                    <div class="mb-3">
                        <span class="original-price" id="book-original-price">@string.Format("{0:N0} đ", Model.originalPrice)</span>
                        <span class="book-price" id="book-price">@string.Format("{0:N0} đ", Model.price)</span>
                    </div>

                    <div class="rating-stars mb-3">
                        <span class="me-2">Đánh giá:</span>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star"></i>
                        <i class="fas fa-star empty"></i>
                    </div>

                    <div class="mb-3">
                        <div class="quantity-controls">
                            <span class="me-2">Số lượng:</span>

                            <input type="number"
                                   id="quantity"
                                   class="form-control mx-1"
                                   value="1"
                                   min="1"
                                   max="9" />

                        </div>
                    </div>

                    @if (Model.quantity - Model.soldQuantity > 0)
                    {
                        <a href="@Url.Action("AddToCart", "CartItems", new { bookId = Model.id })" class="AddToCartBtn btn btn-danger w-100">
                            Thêm vào giỏ
                        </a>
                    }
                    else
                    {
                        <a href="@Url.Action("AddToCart", "CartItems", new { bookId = Model.id })" class="AddToCartBtn btn btn-danger w-100 disabled">
                            Thêm vào giỏ
                        </a>
                    }
                </div>
            </div>
        </div>

        <!-- Book Description and Reviews -->
        <div class="row">
            <div class="col-12">
                <!-- Book Description -->
                <div class="detail-section mb-4">
                    <h4 class="mb-3">Mô tả sản phẩm</h4>
                    <div id="book-description">
                        @Model.description
                    </div>
                </div>

                <!-- Book Reviews -->
                <div class="detail-section mb-4">
                    <h4 class="mb-3">
                        Chất lượng sản phẩm
                        <span class="rating-stars">
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star"></i>
                            <i class="fas fa-star empty"></i>
                        </span>
                    </h4>

                    <div id="review-form" class="mb-4">
                        <div class="mb-3">
                            <label for="review-text" class="form-label">Đánh giá của bạn:</label>
                            <textarea id="review-text"
                                      class="form-control"
                                      rows="3"
                                      placeholder="Nhập đánh giá của bạn..."></textarea>
                        </div>
                        <div class="mb-3">
                            <span class="me-2">Đánh giá:</span>
                            <div class="rating-stars d-inline-block" id="review-rating">
                                <i class="fas fa-star empty" data-rating="1"></i>
                                <i class="fas fa-star empty" data-rating="2"></i>
                                <i class="fas fa-star empty" data-rating="3"></i>
                                <i class="fas fa-star empty" data-rating="4"></i>
                                <i class="fas fa-star empty" data-rating="5"></i>
                            </div>
                        </div>
                        <button type="button"
                                class="btn btn-primary"
                                onclick="submitReview()">
                            Gửi
                        </button>
                    </div>

                    <!-- User Reviews -->
                    <div id="user-reviews">
                        <!-- Review 1 -->
                        <div class="review-box">
                            <div class="d-flex justify-content-between mb-2">
                                <div>
                                    <span class="fw-bold">NTD</span>
                                </div>
                                <div class="review-date">20/04/2025</div>
                            </div>
                            <div class="rating-stars mb-2">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star empty"></i>
                            </div>
                            <p class="mb-0">Đánh giá 1</p>
                        </div>

                        <!-- Review 2 -->
                        <div class="review-box">
                            <div class="d-flex justify-content-between mb-2">
                                <div>
                                    <span class="fw-bold">NTD</span>
                                </div>
                                <div class="review-date">20/04/2025</div>
                            </div>
                            <div class="rating-stars mb-2">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star empty"></i>
                            </div>
                            <p class="mb-0">Đánh giá 2</p>
                        </div>

                        <!-- Review 3 -->
                        <div class="review-box">
                            <div class="d-flex justify-content-between mb-2">
                                <div>
                                    <span class="fw-bold">NTD</span>
                                </div>
                                <div class="review-date">20/04/2025</div>
                            </div>
                            <div class="rating-stars mb-2">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star empty"></i>
                                <i class="fas fa-star empty"></i>
                            </div>
                            <p class="mb-0">Đánh giá 3</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Already Rated Modal -->
    <div class="modal fade"
         id="alreadyRatedModal"
         tabindex="-1"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-notification">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thông báo</h5>
                    <button type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <p class="mb-0">Cảm ơn bạn đã gửi lại đánh giá</p>
                </div>
                <div class="modal-footer justify-content-center">
                    <button type="button"
                            class="btn btn-primary px-4"
                            data-bs-dismiss="modal">
                        OK
                    </button>
                </div>
            </div>
        </div>
    </div>



    <!-- Toast Container -->
    <div id="toast-container"
         class="position-fixed bottom-0 end-0 p-3"
         style="z-index: 1100">
        <!-- Toasts will be appended here -->
    </div>

    <!-- Bootstrap JS Bundle (includes Popper) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <!-- Custom JS -->
    <script src="~/Content/main..js"></script>
    <script>
        let currentRating = 0;
        let selectedBook = null;
        let quantity = 1;

        document.addEventListener("DOMContentLoaded", function () {
            // Show/hide auth buttons based on login state
            const authButtons = document.getElementById("auth-buttons");
            const userDropdown = document.getElementById("user-dropdown");

            if (isLoggedIn()) {
                authButtons.classList.add("d-none");
                userDropdown.classList.remove("d-none");
                const user = getLoggedInUser();
                if (user) {
                    document.getElementById("user-name").textContent =
                        "Xin chào, " + user.name;
                }
            } else {
                authButtons.classList.remove("d-none");
                userDropdown.classList.add("d-none");
            }

            updateCartCount();
            initializeRatingStars();
            // Add mock reviews if none exist
            addMockReviewsIfEmpty();
            // Then load book details (which will load reviews)
            loadBookDetails();
        });

        

        function loadBookDetails() {
            // Get book ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const bookId = urlParams.get("id");

            // Mock book data - in a real app, this would come from an API
            const books = [
                {
                    id: 1,
                    title: "Tôi Thấy Hoa Vàng Trên Cỏ Xanh",
                    author: "Nguyễn Nhật Ánh",
                    price: 120000,
                    originalPrice: 150000,
                    stock: 5,
                    image:
                        "https://images-na.ssl-images-amazon.com/images/S/compressed.photo.goodreads.com/books/1545314990i/10433999.jpg",
                    category: "Văn học",
                    description: `"Tôi thấy hoa vàng trên cỏ xanh" là tác phẩm được nhiều người bình chọn là hay nhất của nhà văn Nguyễn Nhật Ánh. Tác phẩm đã được dựng thành phim điện ảnh vào năm 2015.

              Cuốn sách viết về tuổi thơ nghèo khó của hai anh em Thiều và Tường, cùng chuyện tình cảm của họ với cô bé Mận. Chuyện tình của họ hồn nhiên và trong sáng, nhưng cũng đầy những rung động đầu đời khó quên.

              Bối cảnh là một làng quê nghèo vào khoảng những năm 1980, khi mà người dân vẫn còn đang gặp nhiều khó khăn sau chiến tranh. Nhưng chính trong cái nghèo khó ấy, tình cảm gia đình, tình bạn, tình yêu của những đứa trẻ lại trở nên thật đẹp và đáng trân trọng.`,
                },
                {
                    id: 2,
                    title: "Nhà Giả Kim",
                    author: "Paulo Coelho",
                    price: 85000,
                    originalPrice: 110000,
                    stock: 10,
                    image:
                        "https://salt.tikicdn.com/cache/w1200/ts/product/c2/32/05/7518554581ec67f4b731073202f04929.jpg",
                    category: "Văn học",
                    description: `"Nhà giả kim" là một cuốn tiểu thuyết được viết bởi Paulo Coelho, lần đầu xuất bản bằng tiếng Bồ Đào Nha vào năm 1988. Cuốn sách kể về Santiago, một cậu bé chăn cừu ở Andalusia, người đã có một giấc mơ lặp đi lặp lại về việc tìm thấy kho báu ở Ai Cập.

              Được thúc đẩy bởi giấc mơ và lời khuyên của một vị vua già, Santiago bắt đầu cuộc hành trình đầy thách thức qua sa mạc Sahara để tìm kiếm kho báu. Trên hành trình của mình, cậu gặp gỡ nhiều nhân vật thú vị, học hỏi về tình yêu, lòng dũng cảm và theo đuổi "Ý nghĩa cuộc sống".

              "Nhà giả kim" là một câu chuyện mang tính biểu tượng về việc khám phá định mệnh cá nhân và hiểu rằng hạnh phúc thực sự đến từ việc theo đuổi ước mơ của chính mình.`,
                },
            ];

            // Find the book by ID or use the first book as default
            selectedBook = books.find((book) => book.id == bookId) || books[1];

            // Update the page with book details
            document.getElementById("book-title").textContent = selectedBook.title;
            document.getElementById("book-author").textContent =
                selectedBook.author;
            document.getElementById("book-category").textContent =
                selectedBook.category;
            document.getElementById("book-stock").textContent = selectedBook.stock;
            document.getElementById("book-price").textContent = formatCurrency(
                selectedBook.price
            );
            document.getElementById("book-original-price").textContent =
                formatCurrency(selectedBook.originalPrice);
            document.getElementById("book-image").src = selectedBook.image;
            document.getElementById("book-description").innerHTML =
                selectedBook.description
                    .split("\n\n")
                    .map((p) => `<p>${p}</p>`)
                    .join("");

            // Update page title
            document.title = `${selectedBook.title} - Nhà Sách Online`;

            // Load reviews for this book
            loadReviews();
        }

        function initializeRatingStars() {
            // Setup event listeners for the rating stars in the review form
            const ratingStars = document.querySelectorAll(
                "#review-rating .fa-star"
            );

            ratingStars.forEach((star) => {
                star.addEventListener("mouseover", function () {
                    const rating = parseInt(this.dataset.rating);
                    highlightStars(rating);
                });

                star.addEventListener("click", function () {
                    const rating = parseInt(this.dataset.rating);
                    currentRating = rating;
                    highlightStars(rating);
                });
            });

            document
                .getElementById("review-rating")
                .addEventListener("mouseout", function () {
                    highlightStars(currentRating);
                });
        }

        function highlightStars(rating) {
            const stars = document.querySelectorAll("#review-rating .fa-star");
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.remove("empty");
                } else {
                    star.classList.add("empty");
                }
            });
        }

        function submitReview() {
            if (!isLoggedIn()) {
                alert("Vui lòng đăng nhập để đánh giá sản phẩm!");
                window.location.href = "/pages/sign-in.html";
                return;
            }

            const reviewText = document.getElementById("review-text").value.trim();

            if (reviewText === "") {
                alert("Vui lòng nhập nội dung đánh giá!");
                return;
            }

            if (currentRating === 0) {
                alert("Vui lòng chọn số sao đánh giá!");
                return;
            }

            // Create review object
            const user = getLoggedInUser();
            const review = {
                id: Date.now(),
                bookId: selectedBook.id,
                userId: user.id,
                userName: user.name || "NTD",
                rating: currentRating,
                text: reviewText,
                date: new Date().toLocaleDateString("vi-VN"),
            };

            // Get existing reviews from localStorage
            let reviews = localStorage.getItem("bookReviews");
            reviews = reviews ? JSON.parse(reviews) : [];

            // Add the new review
            reviews.push(review);

            // Save back to localStorage
            localStorage.setItem("bookReviews", JSON.stringify(reviews));

            // Show the notification modal
            const modal = new bootstrap.Modal(
                document.getElementById("alreadyRatedModal")
            );
            modal.show();

            // Clear form
            document.getElementById("review-text").value = "";
            currentRating = 0;
            highlightStars(0);

            // Refresh the reviews display
            loadReviews();
        }

        function loadReviews() {
            // Get reviews from localStorage
            let reviews = localStorage.getItem("bookReviews");
            reviews = reviews ? JSON.parse(reviews) : [];

            // Filter reviews for current book
            const bookReviews = reviews.filter(
                (review) => review.bookId === selectedBook.id
            );

            // Get the reviews container
            const reviewsContainer = document.getElementById("user-reviews");
            reviewsContainer.innerHTML = "";

            // If no reviews, show message
            if (bookReviews.length === 0) {
                reviewsContainer.innerHTML =
                    '<p class="text-muted">Chưa có đánh giá nào cho sản phẩm này</p>';
                return;
            }

            // Add reviews to the container
            bookReviews.forEach((review) => {
                const reviewElement = document.createElement("div");
                reviewElement.className = "review-box";

                // Create the stars HTML
                let starsHtml = "";
                for (let i = 1; i <= 5; i++) {
                    if (i <= review.rating) {
                        starsHtml += '<i class="fas fa-star"></i>';
                    } else {
                        starsHtml += '<i class="fas fa-star empty"></i>';
                    }
                }

                reviewElement.innerHTML = `
                          <div class="d-flex justify-content-between mb-2">
                            <div>
                              <span class="fw-bold">${review.userName}</span>
                            </div>
                            <div class="review-date">${review.date}</div>
                          </div>
                          <div class="rating-stars mb-2">
                            ${starsHtml}
                          </div>
                          <p class="mb-0">${review.text}</p>
                        `;

                reviewsContainer.appendChild(reviewElement);
            });

            // Update the overall rating
            updateOverallRating(bookReviews);
        }

        function updateOverallRating(reviews) {
            if (reviews.length === 0) return;

            // Calculate average rating
            const totalRating = reviews.reduce(
                (sum, review) => sum + review.rating,
                0
            );
            const averageRating = totalRating / reviews.length;

            // Update the stars in the product heading
            const ratingContainer = document.querySelector("h4.mb-3 .rating-stars");
            if (ratingContainer) {
                const stars = ratingContainer.querySelectorAll(".fa-star");
                stars.forEach((star, index) => {
                    if (index < Math.floor(averageRating)) {
                        star.classList.remove("empty");
                    } else if (
                        index === Math.floor(averageRating) &&
                        averageRating % 1 >= 0.5
                    ) {
                        star.classList.remove("empty");
                        star.classList.add("fa-star-half-alt");
                    } else {
                        star.classList.add("empty");
                    }
                });
            }
        }

        function incrementQuantity() {
            const quantityInput = document.getElementById("quantity");
            const currentValue = parseInt(quantityInput.value);
            if (currentValue < selectedBook.stock) {
                quantityInput.value = currentValue + 1;
                quantity = currentValue + 1;
            }
        }

        function decrementQuantity() {
            const quantityInput = document.getElementById("quantity");
            const currentValue = parseInt(quantityInput.value);
            if (currentValue > 1) {
                quantityInput.value = currentValue - 1;
                quantity = currentValue - 1;
            }
        }

        function addToCartFromDetail() {
            if (!isLoggedIn()) {
                alert("Vui lòng đăng nhập để thêm vào giỏ hàng!");
                window.location.href = "/pages/sign-in.html";
                return;
            }

            if (!selectedBook) {
                alert("Không tìm thấy thông tin sách!");
                return;
            }

            // Get cart from localStorage
            let cart = localStorage.getItem("cart");
            cart = cart ? JSON.parse(cart) : [];

            // Check if book already in cart
            const existingItem = cart.find((item) => item.id === selectedBook.id);

            if (existingItem) {
                // Check if adding more would exceed stock
                if (existingItem.quantity + quantity > selectedBook.stock) {
                    alert(
                        "Không thể thêm thêm sản phẩm vì sẽ vượt quá số lượng trong kho!"
                    );
                    return;
                }
                existingItem.quantity += quantity;
            } else {
                cart.push({ ...selectedBook, quantity: quantity });
            }

            // Save cart and update UI
            localStorage.setItem("cart", JSON.stringify(cart));
            updateCartCount();
            showCartModal(selectedBook);
        }

        // Format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat("vi-VN", {
                style: "currency",
                currency: "VND",
            }).format(amount);
        }</script>
    <script>
        document.querySelectorAll('.AddToCartBtn').forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault(); // Ngăn tải trang
                fetch(this.href)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) alert('Đã thêm vào giỏ hàng!');
                        else alert('Lỗi thêm giỏ hàng');
                    })
                    .catch(() => alert('Lỗi kết nối'));
            });
        });
    </script>
    
</body>
</html>
